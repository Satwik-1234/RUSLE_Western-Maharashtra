name: CI — Lint, Test & Validate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:

  # ─────────────────────────────────────────────────────────────────────────
  lint:
    name: Code Quality (flake8 + nbstripout)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install linting tools
        run: |
          pip install flake8 nbstripout nbformat

      - name: Lint Python scripts
        run: |
          flake8 scripts/ tests/ --max-line-length=110 --ignore=E501,W503 --count

      - name: Validate notebook structure
        run: |
          python - <<'EOF'
          import json, sys
          with open("notebooks/Western_Maharashtra_Erosion_30m.ipynb") as f:
              nb = json.load(f)
          cells = nb["cells"]
          code_cells = [c for c in cells if c["cell_type"] == "code"]
          print(f"  ✓ Notebook valid: {len(cells)} cells ({len(code_cells)} code)")
          assert nb["nbformat"] == 4, "Expected nbformat 4"
          print("  ✓ nbformat == 4")
          EOF

  # ─────────────────────────────────────────────────────────────────────────
  test:
    name: Unit Tests (offline — no GEE)
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies (offline subset)
        run: |
          pip install numpy pandas scipy scikit-learn statsmodels pytest pytest-cov

      - name: Run offline unit tests
        run: |
          pytest tests/ -v --tb=short \
            --ignore=tests/test_gee_integration.py \
            --cov=scripts --cov-report=xml

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false

  # ─────────────────────────────────────────────────────────────────────────
  config-validate:
    name: Validate config/analysis_config.json
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON config
        run: |
          python - <<'EOF'
          import json, sys
          with open("config/analysis_config.json") as f:
              cfg = json.load(f)
          required = ["start_year","end_year","resolution","crs","districts",
                      "sample_n","n_clusters","class_breaks","class_labels"]
          for key in required:
              assert key in cfg, f"Missing key: {key}"
          assert cfg["resolution"] == 30, "Resolution must be 30m"
          assert cfg["crs"] == "EPSG:32643", "CRS must be EPSG:32643"
          assert len(cfg["class_breaks"]) == len(cfg["class_labels"]) + 1
          print(f"  ✓ config valid — {len(cfg)} keys, resolution={cfg['resolution']}m")
          EOF
